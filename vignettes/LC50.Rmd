---
title: "LC50"
author: "A. Proctor and S Wotherspoon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Intro



## Model

LC50 lethal concentrations for each combination of additional
stressors are estimated by fitting a Binomial regression model that
relates survival to log toxin concentration, adjusting for background
mortality and assuming a linear relation between log LC50 and
descriptors of the additional stressors.

More precisely, the a Binomial regression model parametrized in terms
of log LC50 is used to relate survival to log toxin concentration
$$
\begin{align}
	y_{ijk} &\sim \operatorname{Bin}(n_{ijk},\pi_{ij})\\
	\pi_{ij} &=
		\begin{cases}
			p_{ij}q_{i} & C_{i} > 0\\
			q_{i} & C_{i}= 0
		\end{cases}\\
	\ell_{1}(p_{ij}) &= \alpha_{i} (\log C_{ij} - \log\mathrm{LC50}_{i})\\
	\log \mathrm{LC50}_{i} &= \beta_{0} + \beta_{1} x_{1i} + \dots + \beta_{m}x_{mi}\\
	\ell_{2}(q_{i}) &= \gamma_{i}
\end{align}
$$
Here $y_{ijk}$ is the number of survivors, $n_{ijk}$ is the total
number of individuals and $\pi_{ij}$ is the fraction of individuals
expected to survive in replicate $k$ receiving toxin concentration
$C_{ij}$ and the $i^{\mathrm{th}}$ combination of additional
stressors. The total survival fraction $\pi_{ij}$ is decomposed into a
fraction $q_{i}$ of individuals expected to survive in the absence of
the toxin, and a fraction $p_{ij}$ expected to survive the additional
mortality induced by the toxin.  The fraction $p_{ij}$ is related to
the log toxin concentration $\log C_{ij}$, the log lethal
concentration $\log \mathrm{LC50}_{i}$ and a rate parameter
$\alpha_{i}$ specific to the combination of stressors through a
monotonic link function $\ell_{1}$ with the property that
$\ell_{2}(1/2) = 0$, so that $p_{ij}=1/2$ when $C_{ij} =
\mathrm{LC50}_{i}$.  Similarly, the baseline survival fraction $q_{i}$
is related to a survival parameter $\gamma_{i}$ specific to the
combination of stressors through a monotonic link function $\ell_{2}$.
The lethal concentration $\mathrm{LC50}_{i}$ specific to a stressor
combination is related through a log link to a linear predictor
constructed from covariates $x_{1},x_{2},\ldots,x_{m}$ describing the
combination of additional stressors.

The baseline survival parameters $\gamma_{i}$ and rate parameters
$\alpha_{i}$ are viewed as nuisance parameters, and inference focuses
on the effects of the additional stressors and the LC50 lethal
concentrations.



## Example

The `toxicity` dataset is simulated data showing survival following
exposure to a known toxin in the presence of the additional stressors
temperature and salinity.  In the imagined scenario,  samples of an
aqueous solution of a toxin, of varying concentrations, are prepared
for each of three salinities and are held at one of three constant
temperatures.  Approximately 10 individuals were added to each sample
and the number of survivors recorded at the end of four days exposure.
```{r}
library(LC50)
head(toxicity)
```

### Graphical Exploration

Plotting the survival fraction against concentration for each
combination of additional stressors shows that survival does decrease
with increasing concentrations of the toxin, and in many samples there
is a non-negligible level of control mortality
```{r,fig.width=7,fig.height=6}
library(ggplot2)
ggplot(toxicity,aes(x=conc,y=alive/total,colour=group))+
  geom_point()+
  facet_grid(temperature~salinity)
```


### Model fitting

The LC50 lethal concentrations for each temperature and salinity
combination can be estimated with `lc50`.  This function fits the
Binomial model described in the previous section by maximum
likelihood.  The details of the model are specified by three
arguments:

* a formula, the left hand side of which is a two column matrix
  constructed from the number of survivors and mortalities in each
  sample, while the right hand side specifies the terms in the linear
  predictor for log LC50

* the `concentration` argument names the variable in the dataframe
  recording the concentration of the toxin, and

* the `group` argument names a factor in the dataframe that
  disinguishes the combinations of additional stressors.  The model
  requires that the terms of linear predictor for log LC50 are
  constant within levels of this factor.

```{r}
fit <- lc50(cbind(alive,dead)~salinity*temperature,concentration=conc,group=group,data=toxicity)
summary(fit)
```
By default, a probit link is used and separate background survival
rates are estimated for each group.


An analysis of deviance table for the fit is constructed with `anova`.
```{r}
anova(fit,test="Chisq")
```
This table shows no evidence that log LC50 depends on the interaction,
and the model can be simplified to a main effects only model for log
LC50.  Although this fits a restricted model for log LC50, it still
fits a separate control parameter $\gamma_{i}$ and rate parameter
$\alpha_{i}$ for each group.
```{r}
fit <- lc50(cbind(alive,dead)~salinity+temperature,concentration=conc,group=group,data=toxicity)
summary(fit)
```

The table of lethal concentrations can be extracted from the summary and displayed graphically
```{r,fig.width=7,fig.height=6}
lc50 <- as.data.frame(summary(fit)$lc50)
lc50 <- cbind(group=rownames(lc50),lc50)
ggplot(lc50,aes(x=group,y=LC50))+
  geom_linerange(mapping=aes(x=group,ymin=`Lwr 95%`,ymax=`Upr 95%`),col="dodgerblue1",lwd=3)+
  geom_point()
```

Predictions from the fitted model can be generated with `predict`.
```{r,fig.width=7,fig.height=6}
d.pr <- expand.grid(temperature=factor(c(12,14,16)),
                    salinity=factor(c(31,33,35)),
                    conc=0:90)
d.pr$group <- with(d.pr,interaction(temperature,salinity,sep="|"))
d.pr$survival <- predict(fit,d.pr)
ggplot(toxicity,aes(x=conc,y=alive/total,colour=group))+
  geom_point()+
  geom_line(aes(x=conc,y=survival,colour=group),data=d.pr)+
  facet_grid(temperature~salinity)
```



The confidence intervals shown in the summary are based on an
asymptotic approximation and can be unreliable in small samples.  As
an alternative, confidence intervals for the lethal concentrations can
be calculated by parametric bootstrap - new data sets are simulated
from the fitted model and the model refitted to the simulated data,
confidence intervals are then derived from the variability seen in the
estimates from the simulated data.

```{r}
d.boot <- toxicity
boot <- lapply(simulate(fit,100),function(s) {
  ## Update data
  d.boot[,colnames(s)] <- s;
  ## Refit model and extract lc50s
  update(fit,data=d.boot,start=fit)})
## Summaries of bootstrap estimates
lc50 <- sapply(boot,function(fit) exp(fit$loglc50))
t(apply(lc50,1,function(lc50) c(LC50=mean(lc50),quantile(lc50,c(0.025,0.975)))))
```


Confidence intervals for predictions can be generated similarly
```{r,fig.width=7,fig.height=6}
pr <- sapply(boot,function(fit) predict(fit,d.pr))
d.pr <- cbind(d.pr,t(apply(pr,1,quantile,c(0.025,0.975))))
ggplot(toxicity,aes(x=conc,y=alive/total,colour=group))+
  geom_point()+
  geom_ribbon(aes(x=conc,y=survival,ymin=`2.5%`,ymax=`97.5%`,fill=group),data=d.pr,alpha=0.2,color=NA)+
  geom_line(aes(x=conc,y=survival,colour=group),data=d.pr)+
  facet_grid(temperature~salinity)
```


### Multiple Comparisons

Multiplicity adjusted pairwise comparison tests can be constructed with
`glht` from the `multcomp` package.
```{r,warning=FALSE}
library(multcomp)
mc <- glht(fit,linfct=mcp(salinity="Tukey",temperature="Tukey"))
summary(mc)
```
Multiplicity adjusted confidence intervals for
differences in log LC50 can be obtained with `confint`
```{r}
confint(mc)
```
These intervals can be converted to confidence intervals for ratios of LC50s by
taking exponentials
```{r}
exp(confint(mc)$confint)
```


